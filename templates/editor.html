<!DOCTYPE html>
<html>

<head>
    <title>Klarity Editor</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://npmcdn.com/diff/dist/diff.min.js"></script>

    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/theme/toastui-editor-dark.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/themes/prism.min.css" />
    <link rel="stylesheet"
        href="https://uicdn.toast.com/editor-plugin-code-syntax-highlight/latest/toastui-editor-plugin-code-syntax-highlight.min.css" />

    <style>
        :root {
            --bg-main: #1E1E1E;
            --bg-panel: #252526;
            --bg-hover: #2A2D2E;
            --bg-active: #37373D;
            --border-color-soft: #333333;
            --border-color-hard: #4A4A4A;
            --accent-primary: #c94e51;
            --accent-secondary: #18C5B4;
            --text-main: #D4D4D4;
            --text-dim: #CECECE;
            --radius-base: 6px;
            --radius-small: 4px;
            --font-primary: 'JetBrains Mono', 'Consolas', 'Menlo', monospace;
        }

        * {
            box-sizing: border-box;
        }

        body {
            background: var(--bg-main);
            color: var(--text-main);
            font-family: var(--font-primary);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .toolbar {
            padding: 12px 20px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border-color-soft);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            flex-shrink: 0;
        }

        #file-name {
            color: var(--text-main);
            font-size: 14px;
            font-weight: 500;
            flex: 1;
            min-width: 200px;
        }

        .toolbar-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #patch-btn {
            background: var(--accent-primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: var(--radius-small);
            cursor: pointer;
            font-family: var(--font-primary);
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s, transform 0.1s;
        }

        #patch-btn:hover {
            background: #d65d60;
            transform: translateY(-1px);
        }

        #patch-btn:active {
            transform: translateY(0);
        }

        #patch-btn:disabled {
            background: var(--border-color-hard);
            cursor: not-allowed;
            transform: none;
        }

        #editor-container {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background: var(--bg-main);
            position: relative;
        }

        #editor {
            height: 100%;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-dim);
            font-size: 14px;
        }

        .toastui-editor-defaultUI button:hover {
            color: #eee !important;
        }

        code[class*=language-],
        pre[class*=language-] {
            text-shadow: none !important;
        }
    </style>
</head>

<link rel="stylesheet" href="{{ .Base_URL }}/vars.css">

<body data-pagefind-ignore="all">
    <div class="toolbar">
        <span id="file-name">Loading...</span>
        <div class="toolbar-actions">
            <button id="patch-btn" disabled>Generate Patch</button>
        </div>
    </div>

    <div id="editor-container">
        <div id="editor"></div>
    </div>

    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
    <script
        src="https://uicdn.toast.com/editor-plugin-code-syntax-highlight/latest/toastui-editor-plugin-code-syntax-highlight-all.min.js"></script>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const filePath = urlParams.get('file');
        const rawUrl = "_klarity_raw/" + filePath;

        let originalContent = "";
        let editor = null;

        if (!filePath) {
            document.getElementById('file-name').textContent = "Error: No file specified";
            document.getElementById('editor').innerHTML = '<div class="loading">No file path provided in URL</div>';
        } else {
            loadEditor();
        }

        async function loadEditor() {
            try {
                const res = await fetch(rawUrl);
                if (!res.ok) throw new Error("File not found");

                originalContent = await res.text();
                document.getElementById('file-name').textContent = "Editing: " + filePath;

                const { Editor } = toastui;
                const { codeSyntaxHighlight } = Editor.plugin;

                editor = new Editor({
                    el: document.querySelector('#editor'),
                    height: '100%',
                    initialEditType: 'markdown',
                    previewStyle: 'vertical',
                    theme: 'dark',
                    initialValue: originalContent,
                    usageStatistics: false,
                    autofocus: true,
                    plugins: [codeSyntaxHighlight]
                });

                const patchBtn = document.getElementById('patch-btn');
                patchBtn.disabled = false;
                patchBtn.addEventListener('click', generatePatch);

            } catch (err) {
                document.getElementById('file-name').textContent = "Error loading file";
                document.getElementById('editor').innerHTML =
                    '<div class="loading">Error: ' + err.message + '</div>';
                console.error("Error loading file:", err);
            }
        }

        function generatePatch() {
            if (!editor) {
                alert("Editor not initialized");
                return;
            }

            const newContent = editor.getMarkdown();
            const normOriginal = originalContent.replace(/\r\n/g, '\n');
            const normNew = newContent.replace(/\r\n/g, '\n');

            if (normNew === normOriginal) {
                alert("No changes detected");
                return;
            }

            const patch = Diff.createTwoFilesPatch(
                filePath,
                filePath,
                originalContent,
                newContent,
                "Original",
                "Edited"
            );

            downloadPatch(patch);
        }

        function downloadPatch(content) {
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filePath.replace(/\//g, '_') + ".patch";
            a.click();
            URL.revokeObjectURL(url);
        }

        window.addEventListener('beforeunload', function (e) {
            if (editor && editor.getMarkdown() !== originalContent) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>

</html>
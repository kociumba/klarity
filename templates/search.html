<link href="{{ .BundlePath }}pagefind-ui.css" rel="stylesheet">
<script src="{{ .BundlePath }}pagefind-ui.js" type="module"></script>

<div id="klarity-search-floating">
    <button id="search-toggle" aria-label="Open search">
        Search <kbd>Ctrl K</kbd>
    </button>
    <div id="search-container" class="hidden">
        <div id="search-input"></div>
    </div>
</div>

<style>
    #klarity-search-floating {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        font-family: var(--font-primary);
    }

    #search-toggle {
        background: var(--bg-panel);
        color: var(--text-dim);
        border: 1px solid var(--border-color-soft);
        border-radius: var(--radius-base);
        padding: 0.65rem 1.1rem;
        font-size: 0.95rem;
        font-weight: 500;
        cursor: pointer;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.25);
        transition: all 0.2s ease;
        backdrop-filter: blur(10px);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    #search-toggle:hover {
        background: var(--bg-hover);
        color: var(--text-main);
        border-color: var(--border-color-hard);
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }

    #search-toggle kbd {
        background: var(--bg-hover);
        color: var(--text-dim);
        font-size: 0.7em;
        font-weight: 600;
        padding: 2px 6px;
        border-radius: 4px;
        border: 1px solid var(--border-color-soft);
    }

    #search-container {
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 10px;
        width: 35vw;
        max-width: 92vw;
        background: var(--bg-panel);
        border: 1px solid var(--border-color-soft);
        border-radius: var(--radius-base);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.35);
        overflow: hidden;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-12px);
        transition: all 0.28s cubic-bezier(0.4, 0, 0.2, 1);
        backdrop-filter: blur(16px);
    }

    #search-container.visible {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    .pagefind-ui__form {
        position: relative;
    }

    .pagefind-ui__search-input {
        width: 100%;
        padding: 1rem 5rem 1rem 3.2rem !important;
        background: var(--bg-main);
        border: none;
        border-bottom: 1px solid var(--border-color-soft);
        color: var(--text-main);
        font-size: 1.05rem;
        font-family: var(--font-primary);
        outline: none;
    }

    .pagefind-ui__search-input:focus {
        outline: none !important;
        box-shadow: none !important;
    }

    .pagefind-ui__search-input::placeholder {
        color: var(--text-dim);
    }

    .pagefind-ui__search-clear {
        position: absolute !important;
        top: 4% !important;
        height: fit-content !important;
        right: 0.9rem !important;
        transform: translateY(-50%);
        background: var(--bg-hover) !important;
        color: var(--text-dim) !important;
        border: 1px solid var(--border-color-soft) !important;
        border-radius: var(--radius-small);
        padding: 0.4rem 0.75rem !important;
        font-size: 0.85rem !important;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        z-index: 2;
    }

    .pagefind-ui__search-clear:focus {
        outline: 2px solid var(--accent-primary) !important;
        outline-offset: 2px;
    }

    .pagefind-ui__search-clear:hover {
        background: var(--bg-active) !important;
        color: var(--text-main) !important;
        border-color: var(--border-color-hard) !important;
    }

    .pagefind-ui__message {
        margin: 0.9rem 1.1rem 0.4rem !important;
        padding: 0 !important;
        color: var(--text-dim);
        font-size: 0.95rem;
        text-align: left !important;
    }

    .pagefind-ui__results-area {
        max-height: 70vh;
        overflow-y: auto;
        padding: 0.4rem;
    }

    .pagefind-ui__result {
        padding: 0.9rem;
        border-radius: var(--radius-small);
        transition: background 0.2s;
        margin: 0.2rem 0.4rem;
        max-width: unset !important;
    }

    .pagefind-ui__result:hover,
    .pagefind-ui__result:focus-within {
        background: var(--bg-hover);
    }

    .pagefind-ui__result-title,
    .pagefind-ui__result-link {
        color: var(--text-main) !important;
        font-weight: 600;
        font-size: 1rem;
    }

    .pagefind-ui__result-link {
        color: var(--accent-primary) !important;
        text-decoration: none;
    }

    .pagefind-ui__result-link:hover {
        text-decoration: underline;
    }

    .pagefind-ui__result-excerpt {
        color: var(--text-dim);
        font-size: 0.92rem;
        line-height: 1.5;
        margin-top: 0.35rem;
    }

    .pagefind-ui__result-excerpt mark {
        /* background: rgba(var(--accent-primary), 0.25); */
        /* color: var(--text-main); */
        font-weight: 600;
    }

    .pagefind-ui__result-nested {
        margin-top: 0.75rem;
        padding-left: 1.2rem;
        border-left: 2px solid var(--border-color-soft);
    }

    .pagefind-ui__result-nested .pagefind-ui__result-title {
        font-size: 0.95rem;
    }

    :root {
        --pagefind-ui-scale: 1;
        --pagefind-ui-primary: var(--accent-primary);
        --pagefind-ui-text: var(--text-main);
        --pagefind-ui-background: var(--bg-panel);
        --pagefind-ui-border: var(--border-color-soft);
        --pagefind-ui-tag: var(--bg-hover);
        --pagefind-ui-border-width: 1px;
        --pagefind-ui-border-radius: 6px;
        --pagefind-ui-font: var(--font-primary);
    }

    .pagefind-ui__results,
    .pagefind-ui__result-inner,
    .pagefind-ui__result-thumb {
        all: unset;
    }

    .pagefind-ui__result-thumb {
        width: 0px !important;
    }
</style>

<script type="module">
    document.addEventListener("DOMContentLoaded", () => {
        const container = document.getElementById("search-container");
        const toggle = document.getElementById("search-toggle");

        let pagefindUI = null;

        const open = () => {
            container.classList.add("visible");
            setTimeout(() => {
                const input = container.querySelector("input");
                if (input) {
                    input.focus();
                }
            }, 100);
        };
        const close = () => container.classList.remove("visible");

        toggle.addEventListener("click", (e) => {
            e.stopPropagation();
            container.classList.contains("visible") ? close() : open();
        });

        document.addEventListener("keydown", (e) => {
            if (e.key === "Escape") close();
            if ((e.ctrlKey || e.metaKey) && e.key === "k") {
                e.preventDefault();
                container.classList.contains("visible") ? close() : open();
            }
        });

        document.addEventListener("click", (e) => {
            if (!document.getElementById("klarity-search-floating").contains(e.target)) {
                close();
            }
        });

        pagefindUI = new PagefindUI({
            element: "#search-input",
            bundlePath: "{{ .BundlePath }}",
            showSubResults: true,
            showImages: true,
            excerptLength: 18,
            resetStyles: false,
            debounceTimeoutMs: 0,
            autofocus: true,
        });

        window.__pagefindUI = pagefindUI;
    });
</script>